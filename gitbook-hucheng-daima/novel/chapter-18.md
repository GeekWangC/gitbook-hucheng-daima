# 第十八章 异常的边
# 第十八章 异常的指数

面板上错误率起了规律锯齿，每隔二十分钟探一小峰，又自落回。

“像内存泄漏叠了 GC 的脉。”小齐道。

提高采样，抓下 heap。数处闭包里，意外引用久不释放，像城角积水，日夜不干。

修补既上，锯齿化作一条平滑之线。陈砺在 ADR 写明因、果与替。末尾加一句：莫让焦虑，成代码的闭包。

他把那段闭包的代码片段打印出来，贴在墙上，并在旁边写：当我们把不确定“捕获”进来时，也请给它一个释放的出口。

晚上回到家，他把今天的事情讲给苏棠听。她笑：“你把情绪也当内存管理了。”

“可能吧。”他摊手，“但我在努力写一个不会泄漏的生活。”

# 第十八章 异常的指数

面板上错误率起了规律锯齿，每隔二十分钟探一小峰，又自落回。

“像内存泄漏叠了 GC 的脉。”小齐道。

提高采样，抓下 heap。数处闭包里，意外引用久不释放，像城角积水，日夜不干。修补既上，锯齿化作一条平滑之线。陈砺在 ADR 写明因、果与替。末尾加一句：莫让焦虑，成代码的闭包。

可这只是第一层。第二天夜里，锯齿又回来了。这一次，它的频率变了——从二十分钟变成了十七分钟。Ops 说：“不像纯内存泄漏了。”陈砺让大家关掉群里的“猜想”，回到“事实”。事实写在白板上：

1. 峰值出现于低流量时段；
2. 峰值持续 1–2 分钟；
3. 峰前 CPU 有轻微爬升；
4. 峰后 GC 日志有一条“回收不足”的警告。

第三天，他们把“异常的指数”拆成了两个维度：一个是“症状指数”，一个是“原因指数”。症状指数是人能听懂的话——“用户在 1 分钟里会看到卡顿”；原因指数是工程能验证的东西——“闭包未释放+第三方库在某些边界图上退化到 O(n^2)”。

小齐和辛乔去复现实验。辛乔写了一个“边界图生成器”，同时在脚本里加入了一段“控制变量”的说明。两人像在实验室里做化学反应：一组“正常图”、一组“边界图”、一组“极端图”。三组数据跑下来，异常的锯齿在“边界图”里再次出现。辛乔叫了一声：“找到了！”又马上补了一句：“也许只找到了其中之一。”

第四天，他们请来一位老同学，用火焰图把性能热点一层层剥开。火焰图像一座城市的立体地图，某些地方灯火通明，某些地方一片暗。他们在一处看似不起眼的“字符串拼接”上看到了明显的热——这是第三方库在“极短停顿+边界图”的叠加场景下发生的退化。修复方法不是“改一行”，而是“绕开它”。他们在外围加了一层“缓冲”，让“极短停顿”变成“可控的等待”。

第五天，锯齿消失了。小齐在面板前长出一口气。陈砺没有马上说“好”，只是把“异常的指数”的方法写成了一张卡片：

1. 把“症状”翻成“用户语言”；
2. 把“原因”写成“可复现实验”；
3. 用火焰图验证“猜想”；
4. 修复不是“改一行”，而是“用一个方法包起来”。

他在卡片末尾又加了一句：焦虑是一个很容易被意外引用的变量。

第六天，他们把“异常预算”写进了方法文。不是“预算错误”，而是“错误预算”——当我们在一段时间里消耗了多少“可容忍的错误”，我们是否应该停下来“恢复健康”？他们把“可容忍的错误”翻成了三条可被观察的句子：

1. 不影响关键路径的轻微卡顿，不超过每日 5 分钟；
2. 可被回退的异常，不超过每周 2 次；
3. 未被记录的异常为 0。

这三条写出来后，房间里安静了一会儿。有人说：“我们是在给‘不完美’一个边界。”陈砺点头：“只有边界，才有秩序。”

第七天夜里，他在苏棠的店里写了一段“异常的故事”。他写：

“异常不是怪物。它像风，时强时弱。我们要做的，不是把风关起来，而是学会在有风的日子里稳稳地走。”

他合上本子，觉得心里很安静。窗外的灯正逐一亮起，像一条被点亮的河。那条河里，有风，也有光。

第八天，他们为“错误预算”加上了一个“发布闸门”。闸门不是为了“卡住”，而是为了“提醒”。当“可容忍的错误”被消耗到阈值时，发布按钮会变成黄色，需要“播报员+总指挥”的双人确认。小齐第一次遇到黄色按钮，怔了一秒，然后把“今天不发”的理由写在了 Changelog 的顶端：

“我们在等风小一点。”

第九天，异常降噪机制上线。过去，日志像一片风暴，真正的信号被无关的噪音裹挟。新机制把“重复的告警”折叠，把“相同根因”的报错聚合，把“低价值的嘈杂”关进一个箱子。Ops 的同事在群里发了一个“耳机”的表情，说：“终于可以听见人说话了。”

第十天，他们把“异常—修复—验证—复盘”的闭环写进了 Runbook。闭环的第一步不是“修复”，而是“讲清楚”：

1. 用一句“用户语言”讲清楚发生了什么；
2. 用一段“可复现实验”讲清楚我们如何看见；
3. 用三条“可观察的指标”讲清楚我们如何确信它被解决；
4. 用一行“更早该做什么”讲清楚我们如何不再。

闭环在一次小事故中得到了验证：某个深夜，导出的排队时间突然延长了三倍。播报员先念“用户语言”：“我们知道你在等，我们正在为你打包。”然后宣布“回退”。回退之后，修复团队在 40 分钟里完成了“复现实验”。第二天早晨，三条“可观察指标”全部回到基线。

第十一天的复盘里，有一行很短的注释：

“谢谢昨夜醒着的人。”

第十二天，陈砺把“异常的指数”写成了一张对外可以分享的海报。海报不是为了“显摆”，而是为了“邀请”。它把“症状指数—原因指数—错误预算—发布闸门—降噪—闭环”画成了六个很小的圆，圆与圆之间用细细的线连起来。海报的最下方写着：

“异常是风。我们会在风里走很久，但不会慌张。”

第十三天，他们与后端和 SRE 一起把“错误预算—SLO—发布策略”打通成一张“服务契约”。契约不是约束别人，是约束自己：当我们消耗掉本月的 80% 错误预算时，非关键改动延期；当我们触及 SLO 的警戒线时，必须把“用户语言的影响”写在最上面。有人问：“这样会不会慢？”陈砺说：“会。但我们要的不是一时的快。”

第十四天，小齐把“异常故事”写成了一个演示：

1. 打开一个边界图；
2. 注入一段“极短停顿”；
3. 观察火焰图的变化；
4. 打开“发布闸门”；
5. 听播报员念一句“用户语言”。

演示播给了新同学，也播给了非技术的朋友。最后一幕是“回退按钮被按下”的那一秒。观众席有人轻轻地“嗯”了一声。那一声“嗯”像是一颗很小的石子，落进了水里，激起一个小小的涟漪。
