# 第十一章 影子系统

影子环境启用之日，楼内静得只听见风。网关分流，半数请求入正途，半数潜入“影子”，无声无息。

“不惊扰用户，尽看诸错。”陈砺盯面板，指针如心跳，稳而不乱。

影子库只存匿名、脱敏之迹，每一条日志挂同一条线索。第一道红线亮起，小齐抢点：“渲染的竞态，与老框架的生命周期相撞。”

“在影子里修，修到零，再切五成之一。”

夜行至河边，张江的风凉入骨。他忆起初到沪上，愚园路旧屋无空调，汗如雨落，代码亦如雨落。彼时只知硬扛；如今知道，风险该由影子承之，生活也当由温柔承之。

次日清晨，他们接通合成监控，以“用户旅程”稳定注入流量。曲线轻颤，如人将醒。

“登录偶发 401。”小齐道，“影子里 token 过期，正式环境会续。”

“补续，且只读。”陈砺叮嘱，“明标只读，勿写脏。”

午后，王序至：“不独技术验证。立一块产品看板，把‘我们看见的’翻成‘用户会遇到的’。”

“把指纹翻成人话。”陈砺遂加一条：每一告警，必附“用户感受”。

傍晚，他整诸红线为《影子系统日报·甲》。末句写：求者非零告警，乃零盲区。

# 第十一章 影子系统

影子环境启用之日，楼内静得只听见风。网关分流，半数请求走正途，半数潜入“影子”，无声无息。

“不惊扰用户，尽看诸错。”陈砺盯面板，指针如心跳，稳而不乱。

影子库只存匿名、脱敏之迹，每一条日志挂同一条线索。第一道红线亮起，小齐抢点：“渲染的竞态，与老框架的生命周期相撞。”

“在影子里修，修到零，再切五成之一。”陈砺答。

夜行至河边，张江的风凉入骨。他忆起初到沪上，愚园路旧屋无空调，汗如雨落，代码亦如雨落。彼时只知硬扛；如今知道，风险该由影子承之，生活也当由温柔承之。

第二周，他们把“旅程脚本”从三条扩到九条：登录、检索、下单、取消、退款、上传、导出、切换主题、读屏走查。每一条旅程都绑着一段“用户语言”的说明——不是“XHR 失败”，而是“我点了按钮但没有任何反馈”。这段文字在群里被戏称为“翻译官”，专门把“技术指纹”翻成“人能听懂的话”。

合成监控很快暴露一个“奇怪但真实”的问题：用户从“检索”立刻切到“导出”，网络在某些地区会抖一下，浏览器把两个请求的顺序对调，造成“导出未准备好”。开发环境里几乎不出现，在影子里却像雨夜里猫眼，偶尔闪一下。小齐追进去，发现是边角的节流策略在“极短停顿”时退化。他把“极短”调成“很短”，报错少了一半。陈砺看面板，慢慢道：“再多一点耐心。”

第三周，王序要把“影子日报”改成“周报+早报”。周报讲“结构性问题”，早报讲“昨天发生了什么”。第一篇早报写：

1. 夜间 02:14–02:26，导出旅程在 A 线路出现 3 次“未准备好”；
2. 03:01–03:07，登录旅程在 B 线路出现 1 次“401→200”抖动；
3. 两项均已在影子内修复，尚未切明流；
4. 今日与明日继续观测两点。

早报发出后，有人在评论里回“睡得好吗”。陈砺答：“睡得好，因为看得见。”

第四周，他们第一次尝试“影子切明流”。先 1%，再 5%。第一次的 1%，静得像无人之夜。第二次的 5%，抖了一下，像水里忽然有条鱼。Ops 报来“异常”：监控脚本在某些页里重复加载两次。很快定位：影子环境在某个路径上比正式多一层跳转，致“入口识别”误判。小齐在 YAML 里加“影子特例”，并在 ADR 里写下：“当影子与正式在路径上有差异时，入口识别以映射表为准。”

这个 ADR 的标题是《影子路径与入口识别》。四段：背景、问题、结论、替代。替代是“不要使用隐式路径识别”。末行很短：不要偷懒。

周会后，陈砺把“不要偷懒”圈了三笔。他对小齐说：“影子给我们偷懒的机会，但别利用它。”小齐点头，笑了一下。

第五周，他们请来“外部视角”评审——友商的 SRE 老同学。对方看“旅程脚本”后说：“你们的旅程都‘成功得很漂亮’，能不能写几条‘失败旅程’？”大家一愣。老同学解释：“上传失败后发生什么？导出排队过长会发生什么？”陈砺当即加两条“失败旅程”，一个小时后，面板出现第一条“失败但被好好对待”的记录：

“上传 45 秒未完成，系统提示‘暂时拥挤’，建议 2 分钟后再试；用户在 2 分钟后再次尝试成功。”

记录后来成了样板。再下一周，他们把“失败旅程”的文案也写进风格指南。风格指南第一行：失败不是耻辱，失败是系统教人如何不害怕的方式。

第六周，集团内部做“影子经验交流”。陈砺十分钟的分享只讲两句：

1. 我们从“不知道哪里错了”走到“知道哪里可能错”；
2. 我们从“出错时慌张”走到“出错时坦然”。

有人问：“影子会不会让我们保守？”陈砺说：“不会。它是一条暗渠，不是地下室。暗渠是为了把路修好，不是躲在里面不出来。”

第七周，他们把“影子—明流”的切换做成“回滚轨道”。每一个切换点上，都有清楚的“回退按钮”。小齐说：“看起来有点笨。”陈砺说：“稳的东西，都有一点笨。”

第八周，陈砺把“影子系统日报”写到了第 008 期。第 008 期里，他第一次写下了“无事可报”。他在“无事可报”后面加了一句小字：无事是福，但不是永远。把“失败旅程”常看一眼。

随后两周，旅程脚本又增至十二条：加入“权限变更”“跨时区时间展示”“读屏器在夜间模式下的行为”。他们和设计一起在夜里做了一次“黑夜走查”。办公室所有灯都关了，只留屏幕的光。走查从“起步页”走到“最后一里路”，任何一次“看不见”“听不到”，都要停下来改。某个时刻，他们听见读屏器把一个按钮念成了“未命名”。每个人都沉默了一秒。第二天早上，那处被改回了“清晰、准确的词”。

月末，他们把“影子系统的故事”收束成四点，贴在文档站“方法论”栏目下：

- 旅程写给人看，指标写给人懂；
- 失败要被好好对待；
- 切换要有回滚轨道；
- 结论要在阳光下变更（ADR）。

那一页的最后八个字，依旧是当初的句子：

求者非零告警，乃零盲区。

第九周，他们给“影子系统”加了一个“晨检环”。每天早上 9 点前，旅程脚本自动跑一轮，播报员把“昨夜与今晨”的图发在群里。那天的图很安静，像一张刚刚铺好的雪。有人问：“会不会太安静？”陈砺答：“安静的图，背后是有人在醒着。”

他把这句话也写进了那一页的最后：

“安静，是因为有人醒着；从容，是因为我们练过。”
